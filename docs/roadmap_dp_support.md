# ロードマップ: ダブルプレイ (DP) コントローラー対応

**ステータス:** 計画中 / 将来の機能
**目標**: 2台のIIDXコントローラー（1P側と2P側）を同時に監視し、「ダブルプレイ」(DP) 時の統計管理とメンテナンスを可能にする。

## 1. 概要
現在、SwitchLifeManagerは単一のコントローラーインデックス (`target_controller_index`) を監視しています。DPをサポートするためには、システムは以下の機能を持つ必要があります：
1.  2つの異なるコントローラーインターフェースを同時に識別し、ポーリングする。
2.  2P側のキー割り当てと統計（合計14キー + 2ターンテーブル）を個別に管理する。
3.  デュアルダッシュボード、または統合されたデュアルビューインターフェースを表示する。

## 2. アーキテクチャの変更

### 2.1 ドメインモデル
*   **LogicalKey (論理キー) の拡張**:
    *   `LogicalKey` enumは現在 `Key1`...`Key7`, `E1`...`E4` をサポートしています。
    *   **変更点**: `P2Key1`...`P2Key7`, `P2E1`...`P2E4` を導入します。あるいは、キーを「サイド (1P/2P)」enumでスコープ化します。
    *   *推奨*: `LogicalKey` 自体はシンプルに保ち、マッピングや統計データ内で `ControllerSide` コンテキストを追加するか、ゲーム内部ロジックに合わせて単純に `Key8`...`Key14` を追加する形を検討します。ただし、ユーザーにとっては `P1` / `P2` プレフィックスが最も明確です。

*   **AppConfig (設定)**:
    *   `secondary_controller_index: Option<u32>` を追加します。
    *   DPモードの有効/無効設定を許可します。

### 2.2 ユースケース (監視サービス)
*   **デュアルポーリングループ**:
    *   `MonitorService` ループは、`target_controller_index` (1P) と `secondary_controller_index` (2P) の両方をポーリングする必要があります。
    *   **InputSource**: インデックスのリストを受け取るか、2つのインスタンスを生成する必要があります。
    *   **最適化**: ポーリングは既に高速 (1ms) であるため、同一ループ内で2つのデバイスを順次ポーリングする方法で十分であり、スレッド間の同期による複雑さを回避できます。

### 2.3 データ保存 (プロファイル)
*   `UserProfile` 構造体は、2セット目のスイッチデータを収容できるようにする必要があります。
*   **マイグレーション**: 既存のプロファイルは「シングルプレイ (SP)」用です。DPが有効化された際、スキーマは2Pキーを含むようにシームレスに拡張されるか、`switches` マップが新しい2P `LogicalKey` バリアントを受け入れるようにします。

## 3. UI/UX の変更

### 3.1 設定 (キーコンフィグ)
*   **コントローラー選択**: 「ターゲットデバイス 1 (1P)」と「ターゲットデバイス 2 (2P)」を選択可能にします。
*   **マッピング**: 1Pキーと2Pキーの設定を切り替えるタブまたはトグルを追加します。
*   **学習モード**: 現在どちらのサイドを設定中かを学習機能が認識できるようにします。

### 3.2 ダッシュボード
*   **分割ビュー**:
    *   左カラム: 1Pキー (1-7, E1-E4)
    *   右カラム: 2Pキー (1-7, E1-E4)
*   **統合アクション**: 「一括適用 (Bulk Apply)」は、必要に応じて両サイドの選択状態を扱えるようにします。

### 3.3 入力テスター
*   **ダブルプレイレイアウト**:
    *   レイアウト幅を拡張します。
    *   2つの「ピアノレイアウト」を横に並べて配置し、適切な間隔（ターンテーブルのギャップを表現）を設けます。
    *   左側に1Pキー、右側に2Pキーを配置します。

## 4. 実装ステップ

1.  **バックエンド**:
    *   `AppConfig` を更新し、2Pコントローラーのインデックスを保存可能にする。
    *   `LogicalKey` を更新し、2Pバリアント（例: `P2Key1`）を含める。
    *   `MonitorService` ループを更新し、設定されていれば2台目のコントローラーもポーリングする。
2.  **フロントエンド**:
    *   `Settings` を更新し、2台目のコントローラーを選択可能にする。
    *   `Dashboard` を更新し、2Pキーを描画する（初期は別タブ、または分割ビュー）。
    *   `InputTester` を更新し、14キーを表示する。
3.  **マイグレーション**:
    *   古いプロファイルのロードが正常に動作することを保証する（2Pキーは設定されるまでマップに存在しない状態）。

## 5. USB帯域幅に関する注意
*   2台の高速HIDデバイスを同じUSBハブで1000Hz (1ms) ポーリングすると、ホストコントローラーによっては競合が発生する可能性があります。
*   アプリケーションはループタイミングを監視し、デュアルコントローラー環境で1msポーリングが維持できない場合は警告を出すべきです。